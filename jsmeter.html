<html>
<head>
    <title>jsmeter - 
    
    JavaScript Code Metrics</title>
</head>

<body>
<h1>jsmeter</h1>
<div id="results"></div>
<noscript><p>You may not see it because you have JavaScript turned off.</p></noscript>
<script src="./javascript/jsmeter/tokens.js"></script>
<script src="./javascript/jsmeter/parse.js"></script>
<script src="./javascript/jsmeter/json2.js"></script>
<script src="./javascript/jsmeter/complexity.js"></script>
<script type="text/javascript">
function getParam(name) {
	//from http://www.netlobo.com/url_query_string_javascript.html
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  var regex = new RegExp( regexS );
  var results = regex.exec( window.location.href );
  if( results == null )
    return "";
  else
    return decodeURIComponent(results[1]);
}
</script>
<script type="text/javascript">
/*jslint evil: true */

/*members create, error, message, name, prototype, stringify, toSource,
    toString, write
*/

/*global JSON, make_parse, parse, source, tree */
window.onload = function() {
	run();
}
// Make a new object that inherits members from an existing object.

if (typeof Object.create !== 'function') {
    Object.create = function (o) {
        function F() {}
        F.prototype = o;
        return new F();
    };
}

// Transform a token object into an exception object and throw it.

Object.prototype.error = function (message, t) {
    t = t || this;
    t.name = "SyntaxError";
    t.message = message;
    //debugger;
    throw t;
};
    
function run() {
	var result;
	var d = {
           text : "",
           write : function(t) {
               this.text = this.text + t;
           }
    };
    try {
        parse = make_parse();
        
        source = getParam("code");
		options = JSON.parse(getParam("options") || "{}");
        tree = parse(source);
    
        COMPLEXITY.complexity(tree, "code");
        //COMPLEXITY.renderStats(document.getElementById("results"));
        d.write("<table border=\"0\" >");
        d.write("<tr>");
        d.write("<th>");
        d.write("Line");
        d.write("</th>");
        d.write("<th>");
        d.write("Function");
        d.write("</th>");
        d.write("<th>");
        d.write("Statements");
        d.write("</th>");
        d.write("<th>");
        d.write("Lines");
        d.write("</th>");
        d.write("<th>");
        d.write("Comment Lines");
        d.write("</th>");
        d.write("<th>");
        d.write("Comment%");
        d.write("</th>");
        d.write("<th>");
        d.write("Branches");
        d.write("</th>");
        d.write("<th>");
        d.write("Depth");
        d.write("</th>");
        d.write("<th>");
        d.write("Cyclomatic Complexity");
        d.write("</th>");
        d.write("<th>");
        d.write("Halstead Volume");
        d.write("</th>");
        d.write("<th>");
        d.write("Halstead Potential");
        d.write("</th>");
        d.write("<th>");
        d.write("Program Level");
        d.write("</th>");
        d.write("<th>");
        d.write("MI");
        d.write("</th>");
        d.write("</tr>");
		var fns = COMPLEXITY.getFunctions();
    	for (i in fns) {
			if (!Object[i]) {
				comp = fns[i].complexity();
                mi = fns[i].mi();
                pl = fns[i].halsteadLevel();
                
                d.write("<tr>");
                d.write("<td>");
                d.write(fns[i].lineStart);
                d.write("</td>");
                d.write("<td>");
                d.write(fns[i].name.replace("[[code]].", ""));
                d.write("</td>");
                d.write("<td>");
                d.write(fns[i].s);
                d.write("</td>");
                d.write("<td>");
                d.write(fns[i].lines());
                d.write("</td>");
                d.write("<td>");
                d.write(fns[i].comments);
                d.write("</td>");
                d.write("<td>");
                d.write(fns[i].commentPercent());
                d.write("</td>");
                d.write("<td>");
                d.write(fns[i].b);
                d.write("</td>");
                d.write("<td>");
                d.write(fns[i].blockDepth);
                d.write("</td>");
                d.write("<td " + (comp>11?"style=\"color:red\"":"") + ">");
                d.write(comp);
                d.write("</td>");
                d.write("<td>");
                d.write(fns[i].halsteadVolume());
                d.write("</td>");
                d.write("<td>");
                d.write(fns[i].halsteadPotential());
                d.write("</td>");
                d.write("<td " + (pl<0.01?"style=\"color:red\"":"") + ">");
                d.write(pl);
                d.write("</td>");
                d.write("<td " + (mi<100?"style=\"color:red\"":"") + ">");
                d.write(mi);
                d.write("</td>");
                d.write("</tr>");
			}
		}
		d.write("</table>");
		var val;
		for (i in fns) {
			if (!Object[i]) {
				for (var opt in options) {
					if (opt === 'error') {
						continue;
					}
					var opti = fns[i][opt];
					if (typeof opti === 'function') {
						val = opti();
					}
					else {
						val = opti;
					}
					if (options[opt].length > 0 && options[opt][0] > val) {
						d.write("<div>too small value for " + opt + " in " + fns[i].name.replace("[[code]].", "")  + "</div>");
					} else if (options[opt].length > 1 && options[opt][1] < val) {
						d.write("<div>too large value for " + opt + " in " + fns[i].name.replace("[[code]].", "")  + "</div>");
					}
				}
			}
		}
    } catch (e) {
        document.getElementById("results").innerText = JSON.stringify(e, ['name', 'message', 'from', 'to', 'line', 'key',
                'value', 'arity', 'first', 'second', 'third', 'fourth'], 4);
    }
	window.top.postMessage(JSON.stringify({
		'results': d.text,
		'type': 'jsmeter'
	}), "*");
    delete parse;
    delete source;
    delete tree;
}

</script>
</body>
</html>
